@model ThaoPhuong.Models.TTHANHTOAN
@{
    ViewBag.Title = "AddOrUpdate";
    Layout = ViewBag.layout;
}
<form method="post" enctype="multipart/form-data">
    @{
        if (ViewBag.success != null)
        {
            <div class="alert alert-success" role="alert">@ViewBag.success</div>
        }
        if (ViewBag.error != null)
        {
            <div class="alert alert-danger" role="alert">@ViewBag.error</div>
        }
    }
    <div class="row">
        <!-- thông tin -->
        <div class="col-sm-12 col-md-6 col-lg-6">
            <div class="row">
                <div class="col-12">
                    <h4>Thanh toán</h4>
                </div>
                <input type="text" class="form-control" hidden="hidden" name="ID" value="@Model.ID">
                <!-- So phieu -->
                <div class="col-sm-12 col-md-6 col-lg-6">
                    <div class="form-group row">
                        <div class="col-4">
                            <label for="">Số phiếu</label>
                        </div>
                        <div class="col-8">
                            <input type="text" class="form-control" readonly name="NAME" value="@Model.NAME">
                        </div>
                    </div>
                </div>

                <!-- Khach hang -->
                <div class="col-sm-12 col-md-6 col-lg-6">
                    <div class="form-group row">
                        <div class="col-4">
                            <label for="">Khách hàng</label>
                        </div>
                        <div class="col-8">
                            <select class="form-control ipKhachHang select2" name="DKHACHHANGID">
                                <option value="">Chọn khách hàng</option>
                                @foreach (ThaoPhuong.Models.DKHACHHANG item in ViewBag.khachHangs)
                                {
                                    if (item.ID == Model.DKHACHHANGID)
                                    {
                                        <option value="@item.ID" selected>@item.NAME</option>
                                    }
                                    else
                                    {
                                        <option value="@item.ID">@item.NAME</option>
                                    }
                                }
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Tien hang -->
                <div class="col-sm-12 col-md-6 col-lg-6">
                    <div class="form-group row">
                        <div class="col-4">
                            <label for="">Tiền hàng</label>
                        </div>
                        <div class="col-8">
                            <input type="number" class="form-control ipTIENHANG" name="TIENHANG" value="@Convert.ToInt32(Model.TIENHANG)" readonly>
                        </div>
                    </div>
                </div>

                <!-- Phu phi -->
                <div class="col-sm-12 col-md-6 col-lg-6">
                    <div class="form-group row">
                        <div class="col-4">
                            <label for="">Phụ phí</label>
                        </div>
                        <div class="col-8">
                            @{
                                if (ViewBag.isAdmin)
                                {
                                    <input type="number" class="form-control ipPHUPHI" name="PHUPHI" value="@Convert.ToInt32(Model.PHUPHI)">
                                }
                                else
                                {
                                    <input type="number" class="form-control ipPHUPHI" name="PHUPHI" value="@Convert.ToInt32(Model.PHUPHI)" readonly>
                                }
                            }
                        </div>
                    </div>
                </div>

                <!-- Tong cong -->
                <div class="col-sm-12 col-md-6 col-lg-6">
                    <div class="form-group row">
                        <div class="col-4">
                            <label for="">Tổng cộng</label>
                        </div>
                        <div class="col-8">
                            <input type="number" class="form-control ipTONGCONG" name="TONGCONG" value="@Convert.ToInt32(Model.TONGCONG)" readonly>
                        </div>
                    </div>
                </div>

                <!-- Tong cong -->
                <div class="col-sm-12 col-md-6 col-lg-6">
                    <div class="form-group row">
                        <div class="col-4">
                            <label for="">Hoàn thành</label>
                        </div>
                        <div class="col-8">
                            @{
                                if (ViewBag.isAdmin)
                                {
                                    <input type="checkbox" class="form-control chkKetThuc" @{if (Model.KETTHUC > 0) { <text> checked</text> } else { <text></text> }}>
                                }
                                else
                                {
                                    <input type="checkbox" class="form-control chkKetThuc" readonly @{if (Model.KETTHUC > 0) { <text> checked</text> } else { <text></text> }}>
                                }
                            }
                            <input type="number" class="form-control ipKETTHUC" name="KETHUC" value="@Model.KETTHUC" hidden="hidden">
                        </div>
                    </div>
                </div>

                <!-- ghi chu -->
                <div class="col-sm-12 col-md-6 col-lg-6">
                    <div class="form-group row">
                        <div class="col-4">
                            <label for="">Ghi chú</label>
                        </div>
                        <div class="col-8">
                            <input type="text" class="form-control" name="NOTE" value="@Model.NOTE">
                        </div>
                    </div>
                </div>

            </div>
        </div>
        <!-- Ảnh -->
        <div class="col-sm-12 col-md-6 col-lg-6">
            <div class="row">
                @*Thêm chi tiết mặt hàng*@
                <div class="col-12 justify-content-center">
                    <div class="form-group p-1">
                        <table class="table tblChiTiet">
                            <thead class="thead-light">
                                <tr>
                                    @*<th scope="col">#</th>*@
                                    <th class="col-2" scope="col">Ngày</th>
                                    <th class="col-2" scope="col">Số phiếu</th>
                                    <th class="col-2" scope="col">Quầy</th>
                                    <th class="col-2" scope="col">Tổng cộng</th>
                                    <th class="col-3" scope="col">Ghi chú</th>
                                    <th class="col-1" scope="col"><div class="btn btn-success">+</div></th>
                                </tr>
                            </thead>
                            <tbody>
                                @{
                                    int count = 0;
                                    foreach (ThaoPhuong.Models.TTHANHTOANCHITIET item in Model.TTHANHTOANCHITIETs)
                                    {
                                        DateTime time = item.TDONHANG.TIMECREATED ?? DateTime.Now;
                                        <tr data-id="@item.TDONHANGID" data-loai="@item.TDONHANG.LOAI">
                                            <td>@time.ToString("dd/MM/yyyy")</td>
                                            <td>@item.TDONHANG.NAME</td>
                                            <td>@{if (item.TDONHANG.DQUAY != null) { <text>@item.TDONHANG.DQUAY.NAME</text> }}</td>
                                            <td>@ThaoPhuong.Utils.DbUtils.NumberToText(item.TDONHANG.TONGCONG)</td>
                                            <td><input type="text" class="form-control ipNOTE" placeholder="Ghi chú" name="TTHANHTOANCHITIETs[@count].NOTE" value="@item.NOTE"></td>
                                            <td><input type="text" class="form-control ipTDONHANGID" name="TTHANHTOANCHITIETs[@count].TDONHANGID" value="@item.TDONHANGID" hidden="hidden"><div class="btn btn-danger">-</div></td>
                                        </tr>
                                        count++;
                                    }
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-12 form-group">
            @{
                if (ViewBag.isAdmin)
                {
                    <button type="submit" class="btn btn-primary float-right">Cập nhật</button>
                }
            }
        </div>
    </div>
</form>

<div class="modal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Chọn đơn hàng thanh toán</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                @*chi tiet hien thi o day*@
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary btn-modal-ok">Ok</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

@Scripts.Render("~/Scripts/jquery-3.6.0.js")
<script>
    function convertToInt(param) {
        let val = 0;
        if (param != undefined && param != null && param.length > 0)
        {
            val = parseInt(param);
        }
        return val;
    }

    //function renameControls() {
    //    let tienCong = 0;
    //    $(".tblChiTiet").find("tbody").find("tr").each(function (index, ele) {
    //        //$(ele).find("th")[0].innerText = index + 1;
    //        let name = "TTHANHTOANCHITIETs[" + index + "].SOLUONG";
    //        $(ele).find('.ipTDONHANGID').attr("name", name);
    //        name = "TTHANHTOANCHITIETs[" + index + "].NOTE";
    //        $(ele).find('.ipNOTE').attr("name", name);
    //        tienCong += convertToInt($(ele).find('.ipTONGCONG').val().replace(",", ""));
    //    });
    //    $('.ipTIENHANG').val(tienCong);
    //    let phuPhi = convertToInt($('.ipPHUPHI').val().replace(",", ""));
    //    let tongCong = phuPhi + tienCong;
    //    $('.ipTONGCONG').val(phuPhi);
    //}

    $(".tblChiTiet").find("tbody").on("click", ".btn-danger", function () {
        $(this).closest("tr").remove();
        renameControls();
    });

    $(".tblChiTiet").find("tbody").on("change", ".ipPHUPHI", function () {
        renameControls();
    });

    $('.btn-success').click(function () {
        //renameControls();
        let DKHACHHANGID = $(".ipKhachHang").val();
        if (DKHACHHANGID.length == 0) {
            alert("Bạn chưa chọn khách hàng");
            return;
        }
        //Lấy dữ liệu hiển thị
        $.get("/ThanhToan/SearchHoaDonThanhToan/" + DKHACHHANGID, (data) => {
            $(".modal-body").empty();
            $(".modal-body").append(data);
            $(".modal").modal('show');
        });
    });

    $('.btn-modal-ok').click(function () {
        //Lấy danh sách ID
        let ids = [];
        $('.modal-body').find("input[type=checkbox]").each(function (index, ele) {
            if ($(ele).prop("checked")) {
                ids.push($(ele).closest("tr").attr("data-id"));
            }
        });
        if (ids.length == 0) {
            alert("Chưa chọn hóa đơn nào!");
            return;
        }
        //Kiểm tra cái nào có rồi thì không thêm vào nữa
        $(".tblChiTiet").find("tbody").find("tr").each(function (index, ele) {
            let id = ele.dataset.id;
            if (ids.indexOf(id) != -1) {
                //Xóa
                ids.splice(ids.indexOf(id), 1);
            }
        });
        $(".modal").modal('hide');
        if (ids.length > 0) {
            ids.forEach((val, index) => {
                $('.modal-body').find("tr").each(function (index, ele) {
                    if ($(ele).attr("data-id") == val) {
                        //append data to grid
                        let html = $('<tr data-id="' + val + '" data-loai="' + $(ele).attr("data-loai") + '">' +
                            '<td>' + $(ele).find("td")[1].innerText + '</td>' +
                            '<td>' + $(ele).find("td")[2].innerText + '</td > ' +
                            '<td>' + $(ele).find("td")[3].innerText + '</td > ' +
                            '<td>' + $(ele).find("td")[5].innerText + '</td > '+
                            '<td><input type="text" class="form-control ipNOTE" placeholder="Ghi chú" name="TTHANHTOANCHITIETs[0].NOTE" value=""></td>' +
                            '<td><input type="text" class="form-control ipTDONHANGID" name="TTHANHTOANCHITIETs[0].TDONHANGID" value="' + val + '" hidden="hidden"><div class="btn btn-danger">-</div></td>' +
                            '</tr>');
                        $(".tblChiTiet").append(html);
                    }
                });
            });
            renameControls();
        }
    });

    $('.ipPHUPHI').change(function () {
        renameControls();
    });

    $('.chkKetThuc').change(function () {
        let val = 0;
        /*$('.ipKETTHUC').val($('.chkKetThuc').is(':checked') ? 30 : 0);*/
        $('.ipKETTHUC').attr("value", $('.chkKetThuc').is(':checked') ? 30 : 0);
    });

    function renameControls() {
        let tienHang = 0;
        $(".tblChiTiet").find("tbody").find("tr").each(function (index, ele) {
            let name = "TTHANHTOANCHITIETs[" + index + "].TDONHANGID";
            $(ele).find('.ipTDONHANGID').attr("name", name);
            name = "TTHANHTOANCHITIETs[" + index + "].NOTE";
            $(ele).find('.ipNOTE').attr("name", name);
            tienHang += convertToInt($(ele).find("td")[2].innerText.replace(",", ""));
        });
        $('.ipTIENHANG').val(tienHang);
        $('.ipTONGCONG').val(tienHang + convertToInt($('.ipPHUPHI').val().replace(",", "")));
    }
</script>